= Module 5, Jenkins Pipeline
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/
:keywords: DevOps, Jenkins, Automation, CI, CD

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== Task 1, Create a Multi Steps Freestyle Task
We are going to create a Freestyle Task which has 2 steps.

====
a. Using a python script *bingImage.py* to download picture from https://cn.bing.com/?mkt=zh-CN[bing.com]
b. Copy the downloaded picture to CIFS share *\\192.168.0.201\jenkins* created in module 4.
====

//-

1. Login to *rhel5*

2. Create a folder
+
----
mkdir ~/jenkins_home/pipeline
cd ~/jenkins_home/pipeline
----

3. Download *bingImage.py*
+
----
wget https://raw.githubusercontent.com/HaopengL/Automation_DevOps_Using_Jenkins/master/files/module5/bingImage.py
----

4. Add execute permission
+
----
chmod +x bingImage.py
----

5. Go inside Jenkins container
+
====
Remember the customized image has installed *Python3*. We can run python script from it.
====
+
----
docker exec -it jenkins bash
----

6. Go to folder */var/jenkins_home/pipeline/*
+
----
cd /var/jenkins_home/pipeline/
----

7. Test the python script
+
----
python3 bingImage.py
----

8. Check the picture is downloaded
+
----
ls images
----
+
====
The image is the same as the background of https://cn.bing.com/?mkt=zh-CN
====

9. To avoid confuse for the following steps, delete the downloaded images.
+
====
Jenkins Task will use its own namespace */var/jenkins_home/workspace/<task_name>*,
If you run the python script from Jenkins, the picture will save to */var/jenkins_home/workspace/<task_name>/images/*
====

10. Login *Jenkins* and install *Publish over CIFS* plugin
+
image::5_1_1.png[]


11. Configure CIFS plugin
Go to *Jnekins* => *Manage Jenkins* => *Configure System* => *Publish over CIFS* => *Add*
+
----
Name: jenkins
Hostname: 192.168.0.201
Username: administrator@demo.netapp.com
Password: Netapp1!
Share: jenkins

Advanced:
  SMB Version: SMB v2

Click *Test Configuration*, make sure it is *Success*

Click *Save*
----
+
image::5_1_2.png[]

12. Create a new Freestyle Task
+
----
name: bingImage_freestyle
Project type: Freestyle project
Build: Execute shell
Command: python3 /var/jenkins_home/pipeline/bingImage.py
----
+
----
Add build step: Send files to a windows share
Name: jenkins
Source files: images/*.*
Remove prefix: images/
----
+
image::5_1_3.png[]

13. *Save* => *Build Now* => *build id* => *Console Output*

14. Log into Jenkins container
+
----
ls /var/jenkins_home/workspace/bingImage_freestyle/images
----
+
NOTE: the picture saved to workspace instead of the python script directory

15. Go to Z: driver to check if the picture exist

16. Delete the picture, we will use a pipeline to do the same steps

== Task 2, Create a Multi step pipeline

We are going to create a *Pipeline Task* which will do the same steps as *Task 1*
Basically *Pipeline* is the same as multi steps *freestyle project*

1. Download the Jenkinsfile
make sure you are in the Jenkins Container
go to directory */var/jenkins_home/piepline/*
+
----
wget https://raw.githubusercontent.com/HaopengL/Automation_DevOps_Using_Jenkins/master/files/module5/Jenkinsfile
----

2. Check the contents of Jnekinsfile
+
====
The second step *copy_to_cifs_share* was generated by *Snippet Generator*
Details please check at https://opensource.triology.de/jenkins/pipeline-syntax/
====

3. Create a new Jenkins Task
+
----
name: bingImage_pipeline
Project type: Pipeline
Pipeline: Copy the contents downloaded from *step 1*
----
+
image::5_2_1.png[]

4. *Save* => *Build Now* => *Build ID* => *Console Output*

5. Go to the *Z: Driver*, check the picture downloaded by the Pipeline

== Task 3, Deploy Gitlab container on *rhel6*

We are going to deploy a Gitlab container on *rhel6* as our private *Git Server*
You can also use *Github*, but we will not cover in this lab.
====
Reference
https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-engine
====

1. Login *rhel6*

2. Because Gitlab needs at least 4GB RAM, but our lab vm only has 2 GB, we need add 4GB SWAP
+
----
dd if=/dev/zero of=/swapfile count=4096 bs=1MiB

ls -lh /swapfile

chmod 600 /swapfile

mkswap /swapfile

swapon /swapfile

swapon -s

free -m
----
+
.Make the Swapfile Permanent
----
vi /etc/fstab
----
+
.Add this line
----
/swapfile   swap    swap    sw  0   0
----

3. Create path
+
----
mkdir /srv/Gitlab
export GITLAB_HOME=/srv/gitlab
----

4. Install GitLab using Docker engine
+
----
docker run --detach \
  --hostname rhel6.demo.netapp.com \
  --publish 443:443 --publish 80:80 \
  --name gitlab \
  --restart always \
  --volume $GITLAB_HOME/config:/etc/gitlab \
  --volume $GITLAB_HOME/logs:/var/log/gitlab \
  --volume $GITLAB_HOME/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
----

5. Wait Until GitLab boot up, it may take 5 minutes.
+
----
docker logs -f gitlab
----
wait until logs similar to
+
image::5_3_1.png[]
+
*ctrl + c* to exit

6. Use web browser to access
+
----
http://rhel6.demo.netapp.com
----

7. Set password to *Netapp1!*
+
image::5_3_2.png[]

8. Sign in
+
----
username: root
password: Netapp1!
----

9. Create a project
+
----
Project name: bingImage_blueocean
Visibility Level: Public
----

10. SSH to login *rhel5*
+
----
cd /root/jenkins_home/pipeline

git init

git remote add origin http://rhel6.demo.netapp.com/root/bingimage_blueocean.git

git add .

git commit -m "Initial commit"

git push -u origin master
----

11. Go back to Gitlab to check if files have been uploaded
+
image::5_3_3.png[]

== Task 4, Create a Blue Ocean Pipeline
We are going to use *Blue Ocean* to create a Jenkins Pipeline.

[quote]
Blue Ocean is a new user experience for Jenkins based on a personalizable, modern design that allows users to graphically create, visualize and diagnose Continuous Delivery (CD) Pipelines

1. Login Jenkins and install *Blue Ocean* plugin
+
image::5_4_1.png[]

2. On the left panel, click *Open Blue Ocean*
+
image::5_4_2.png[]

3. Click *New Pipline* on Top Right

4. Choose *Git*
+
----
Repository URL: http://rhel6.demo.netapp.com/root/bingimage_blueocean
Username: root
Password: Netapp1!
----
+
click *Create Credential*
+
click *Create Pipeline*
+
NOTE: if the *git repository* has *Jenkinsfile*, the *pipeline* will run automatically

5. Check Job status
+
Click the latest RUN Number, for example *1*

6. Click different steps to familiar with the layouts

7. On the Jumphost, check *Z: driver*, make sure the picture has been copied to the CIFS share.

8. Go back to Jenkins, on the build page (the same page as step 5), click *Edit* on top right.
+
image::5_4_3.png[]

9. Modify the pipeline using the Editor
+
click *+* to add a step
+
image::5_4_4.png[]
+
====
Click *+ Add step* at right

Name your stage: print_message

click *+ Add step*

Choose *Print Message*

Type some Message, for example *Blue Ocean is Awesome*

Click *Save* on top right

Keep the default value (Commit to master) and click *Save & Run*
====

10. New build is running, click the new build ID and check details
+
image::5_4_5.png[]
+

11. When you click *Save & Run*, the *Jenkinsfile* on *Git Repository* has also been updated.
+
Go to *Gitlab* and check the *Jenkinsfile*
+
image::5_4_6.png[]
